include("curves.jl")
include("richelot_aux.jl")
using Random

function generate_distortion_map(submission::String, E_start::EllipticCurve, P::EllipticCurvePoint)
    @assert P.curve==E_start
    if submission=="SIKEp434"
        try
            global newx, newy = ((18329567746008916163931858758593120214314335182821197383494355502153915929498982544477662503871463834424039270019663704506736050175*x(P)^4 + 24439423661345221551909145011457493619085780243761596511325807336205221239331976725970216671828618445898719026692884939342314733565*x(P)^3 + 12219711830672610775954572505728746809542890121880798255662903668102610619665988362985108335914309222949359513346442469671157366780*x(P)^2 + 24439423661345221551909145011457493619085780243761596511325807336205221239331976725970216671828618445898719026692884939342314733565*x(P) + 18329567746008916163931858758593120214314335182821197383494355502153915929498982544477662503871463834424039270019663704506736050175)//(x(P)^3 + 24439423661345221551909145011457493619085780243761596511325807336205221239331976725970216671828618445898719026692884939342314733565*x(P)^2 + x(P)), (21384495703677068857920501885025306916700057713291396947410081419179568584415479635223939587850041140161379148356274321924525391871*ii*x(P)^7*y(P) + 15274639788340763469943215632160933511928612652350997819578629585128263274582485453731385419892886528686699391683053087088946708480*ii*x(P)^6*y(P) + 21384495703677068857920501885025306916700057713291396947410081419179568584415479635223939587850041140161379148356274321924525391874*ii*x(P)^5*y(P) + 15274639788340763469943215632160933511928612652350997819578629585128263274582485453731385419892886528686699391683053087088946708476*ii*x(P)^4*y(P) + 15274639788340763469943215632160933511928612652350997819578629585128263274582485453731385419892886528686699391683053087088946708476*ii*x(P)^3*y(P) + 21384495703677068857920501885025306916700057713291396947410081419179568584415479635223939587850041140161379148356274321924525391874*ii*x(P)^2*y(P) + 15274639788340763469943215632160933511928612652350997819578629585128263274582485453731385419892886528686699391683053087088946708480*ii*x(P)*y(P) + 21384495703677068857920501885025306916700057713291396947410081419179568584415479635223939587850041140161379148356274321924525391871*ii*y(P))//(x(P)^7 + 24439423661345221551909145011457493619085780243761596511325807336205221239331976725970216671828618445898719026692884939342314733562*x(P)^6 + 10*x(P)^5 + 24439423661345221551909145011457493619085780243761596511325807336205221239331976725970216671828618445898719026692884939342314733557*x(P)^4 + 5*x(P)^3 - x(P)^2))
        catch e
            if isa(e, DivideError)
                return E_start(0)
            end
        end
    elseif submission == "SIKEp503"
        try
            global newx, newy = ((9881882367680338035629439687149508781869140075683772998834247607776882949015570925139186183659518263706455362792565742737236729748264695470865678073855*x(P)^4 + 13175843156907117380839252916199345042492186767578363998445663477035843932020761233518914911546024351608607150390087656982982306331019593961154237431805*x(P)^3 + 6587921578453558690419626458099672521246093383789181999222831738517921966010380616759457455773012175804303575195043828491491153165509796980577118715900*x(P)^2 + 13175843156907117380839252916199345042492186767578363998445663477035843932020761233518914911546024351608607150390087656982982306331019593961154237431805*x(P) + 9881882367680338035629439687149508781869140075683772998834247607776882949015570925139186183659518263706455362792565742737236729748264695470865678073855)//(x(P)^3 + 13175843156907117380839252916199345042492186767578363998445663477035843932020761233518914911546024351608607150390087656982982306331019593961154237431805*x(P)^2 + x(P)), (11528862762293727708234346301674426912180663421631068498639955542406363440518166079329050547602771307657531256591326699860109518039642144716009957752831*ii*x(P)^7*y(P)  + 8234901973066948363024533072624590651557616729736477499028539673147402457512975770949321819716265219755379468993804785614363941456887246225721398394880*ii*x(P)^6*y(P)  + 11528862762293727708234346301674426912180663421631068498639955542406363440518166079329050547602771307657531256591326699860109518039642144716009957752834*ii*x(P)^5*y(P)  + 8234901973066948363024533072624590651557616729736477499028539673147402457512975770949321819716265219755379468993804785614363941456887246225721398394876*ii*x(P)^4*y(P)  + 8234901973066948363024533072624590651557616729736477499028539673147402457512975770949321819716265219755379468993804785614363941456887246225721398394876*ii*x(P)^3*y(P)  + 11528862762293727708234346301674426912180663421631068498639955542406363440518166079329050547602771307657531256591326699860109518039642144716009957752834*ii*x(P)^2*y(P)  + 8234901973066948363024533072624590651557616729736477499028539673147402457512975770949321819716265219755379468993804785614363941456887246225721398394880*ii*x(P)*y(P)  + 11528862762293727708234346301674426912180663421631068498639955542406363440518166079329050547602771307657531256591326699860109518039642144716009957752831*ii*y(P))//(x(P)^7 + 13175843156907117380839252916199345042492186767578363998445663477035843932020761233518914911546024351608607150390087656982982306331019593961154237431802*x(P)^6 + 10*x(P)^5 + 13175843156907117380839252916199345042492186767578363998445663477035843932020761233518914911546024351608607150390087656982982306331019593961154237431797*x(P)^4 + 5*x(P)^3 - x(P)^2))
        catch e
            if isa(e, DivideError)
                return E_start(0)
            end
        end
    elseif submission == "SIKEp610"
        try
            global newx, newy = ((1979205308304947003972715524466215077637670173390416737562805667349229877007918612622419147751371900110786942567913473488500357816594296403055547866854559413010189470836941709832617983*x(P)^4 + 2638940411073262671963620699288286770183560231187222316750407556465639836010558150163225530335162533481049256757217964651333810422125728537407397155806079217346919294449255613110157309*x(P)^3 + 1319470205536631335981810349644143385091780115593611158375203778232819918005279075081612765167581266740524628378608982325666905211062864268703698577903039608673459647224627806555078652*x(P)^2 + 2638940411073262671963620699288286770183560231187222316750407556465639836010558150163225530335162533481049256757217964651333810422125728537407397155806079217346919294449255613110157309*x(P)+ 1979205308304947003972715524466215077637670173390416737562805667349229877007918612622419147751371900110786942567913473488500357816594296403055547866854559413010189470836941709832617983)//(x(P)^3 + 2638940411073262671963620699288286770183560231187222316750407556465639836010558150163225530335162533481049256757217964651333810422125728537407397155806079217346919294449255613110157309*x(P)^2 + x(P)), (2309072859689104837968168111877250923910615202288819527156606611907434856509238381392822339043267216795918099662565719069917084119360012470231472511330319315178554382643098661471387647*ii*x(P)^7*y(P)  + 1649337756920789169977262937055179231364725144492013947969004722791024897506598843852015956459476583425655785473261227907083631513828580335879623222378799510841824559030784758193848320*ii*x(P)^6*y(P)  + 2309072859689104837968168111877250923910615202288819527156606611907434856509238381392822339043267216795918099662565719069917084119360012470231472511330319315178554382643098661471387650*ii*x(P)^5*y(P)  + 1649337756920789169977262937055179231364725144492013947969004722791024897506598843852015956459476583425655785473261227907083631513828580335879623222378799510841824559030784758193848316*ii*x(P)^4*y(P)  + 1649337756920789169977262937055179231364725144492013947969004722791024897506598843852015956459476583425655785473261227907083631513828580335879623222378799510841824559030784758193848316*ii*x(P)^3*y(P)  + 2309072859689104837968168111877250923910615202288819527156606611907434856509238381392822339043267216795918099662565719069917084119360012470231472511330319315178554382643098661471387650*ii*x(P)^2*y(P)  + 1649337756920789169977262937055179231364725144492013947969004722791024897506598843852015956459476583425655785473261227907083631513828580335879623222378799510841824559030784758193848320*ii*x(P)*y(P)  + 2309072859689104837968168111877250923910615202288819527156606611907434856509238381392822339043267216795918099662565719069917084119360012470231472511330319315178554382643098661471387647*ii*y(P))//(x(P)^7 + 2638940411073262671963620699288286770183560231187222316750407556465639836010558150163225530335162533481049256757217964651333810422125728537407397155806079217346919294449255613110157306*x(P)^6 + 10*x(P)^5 + 2638940411073262671963620699288286770183560231187222316750407556465639836010558150163225530335162533481049256757217964651333810422125728537407397155806079217346919294449255613110157301*x(P)^4 + 5*x(P)^3 - x(P)^2))
        catch e
            if isa(e, DivideError)
                return E_start(0)
            end
        end
    elseif submission == "SIKEp751"
        try
            global newx, newy = ((7766038306326978939733326178400103991070542234161803377587142259291009205511859134877162172420800035218414908714130151788902933982391915794783120351578363862732530130059185000768799798214581195235176315138243626404499238682623*x(P)^4 + 10354717741769305252977768237866805321427389645549071170116189679054678940682478846502882896561066713624553211618840202385203911976522554393044160468771151816976706840078913334358399730952774926980235086850991501872665651576829*x(P)^3 + 5177358870884652626488884118933402660713694822774535585058094839527339470341239423251441448280533356812276605809420101192601955988261277196522080234385575908488353420039456667179199865476387463490117543425495750936332825788412*x(P)^2 + 10354717741769305252977768237866805321427389645549071170116189679054678940682478846502882896561066713624553211618840202385203911976522554393044160468771151816976706840078913334358399730952774926980235086850991501872665651576829*x(P)+ 7766038306326978939733326178400103991070542234161803377587142259291009205511859134877162172420800035218414908714130151788902933982391915794783120351578363862732530130059185000768799798214581195235176315138243626404499238682623)//(x(P)^3 + 10354717741769305252977768237866805321427389645549071170116189679054678940682478846502882896561066713624553211618840202385203911976522554393044160468771151816976706840078913334358399730952774926980235086850991501872665651576829*x(P)^2 + x(P)), (9060378024048142096355547208133454656248965939855437273851665969172844073097168990690022534490933374421484060166485177087053422979457235093913640410174757839854618485069049167563599764583678061107705700994617564138582445129727*ii*x(P)^7*y(P)  + 6471698588605815783111105148666753325892118528468169481322618549409174337926549279064301810350666696015345757261775126490752444985326596495652600292981969885610441775049320833973999831845484329362646929281869688670416032235520*ii*x(P)^6*y(P)  + 9060378024048142096355547208133454656248965939855437273851665969172844073097168990690022534490933374421484060166485177087053422979457235093913640410174757839854618485069049167563599764583678061107705700994617564138582445129730*ii*x(P)^5*y(P)  + 6471698588605815783111105148666753325892118528468169481322618549409174337926549279064301810350666696015345757261775126490752444985326596495652600292981969885610441775049320833973999831845484329362646929281869688670416032235516*ii*x(P)^4*y(P)  + 6471698588605815783111105148666753325892118528468169481322618549409174337926549279064301810350666696015345757261775126490752444985326596495652600292981969885610441775049320833973999831845484329362646929281869688670416032235516*ii*x(P)^3*y(P)  + 9060378024048142096355547208133454656248965939855437273851665969172844073097168990690022534490933374421484060166485177087053422979457235093913640410174757839854618485069049167563599764583678061107705700994617564138582445129730*ii*x(P)^2*y(P)  + 6471698588605815783111105148666753325892118528468169481322618549409174337926549279064301810350666696015345757261775126490752444985326596495652600292981969885610441775049320833973999831845484329362646929281869688670416032235520*ii*x(P)*y(P)  + 9060378024048142096355547208133454656248965939855437273851665969172844073097168990690022534490933374421484060166485177087053422979457235093913640410174757839854618485069049167563599764583678061107705700994617564138582445129727*ii*y(P))//(x(P)^7 + 10354717741769305252977768237866805321427389645549071170116189679054678940682478846502882896561066713624553211618840202385203911976522554393044160468771151816976706840078913334358399730952774926980235086850991501872665651576826*x(P)^6 + 10*x(P)^5 + 10354717741769305252977768237866805321427389645549071170116189679054678940682478846502882896561066713624553211618840202385203911976522554393044160468771151816976706840078913334358399730952774926980235086850991501872665651576821*x(P)^4 + 5*x(P)^3 - x(P)^2))
        catch e
        if isa(e, DivideError)
            return E_start(0)
        end
        end
     else
        error("Invalid submission")
        return nothing
    end
    return E_start(newx,newy)
end 


function generate_torsion_points(submission::String,E_start::EllipticCurve)
    if submission=="SIKEp434"
        P2= E_start(9553724478256732948451157315079205124101646336033490370885952071308166798992124992811202548387685875157957892883009582039957376581*ii + 21699521325535002659273640787339999327313834049212900414998849079272270282820552700707512252645882563574168198359808348978897873561, 11359385204665260736742045209640197240261481104338942982248130673106904146512409519912144061169145902892002234762377176849597862395*ii + 9945222498410926306977122338267917810860903168954511623932609752903671298051314757471353019830278292547306861455379199284878967060)
        Q2=E_start(19604339836717509549710969066686372264459697973081403946890247382808930561378448155607092247849356016584979403842015548744304978014*ii + 13283967108535047081193125460377397425875399530051525147866707766037023583342908181755318406190224382376354036602504086144290731817, 16963729134271887968901729441456466908924667286829862619705799794927983572383389687814376053222702766051540173380361804023627290803*ii + 903055390822427241572087660128688651018457557687568539653830710290625291308290514273639423517465266292462661724748678578262942900)
        P3=E_start(11083836458661122128667954479052200256828612332826354283384588113766847864270153461392105182331330206277988183365058872099406952403*ii + 9585364446374251230752567778631934483822654377632369550658812186660948100909981887188791136765457281411221649172430978057365286506, 20434608061027617134400465127425735732387223161281197742767002437481359148254067256537757129946928280132942875328251868281828600099*ii + 17530011583134010139957828510398006085175043812019549048024921810002888986026821631279762683455166169782546060200281087399763334508)
        Q3=E_start(22595597979887473689439907557119883206918754271361861927588682411748031438277546817999308588952952587457524519745035398820548041711*ii + 3065194801323699462161306136860740498822562703057758701409680837691588751186231864971959113299924868266654609313323974497514055130, 15972180129422863676534743681531802279938356667484695801556795536720185447154517198698223460775572868282952007178660233415757545590*ii + 20985132163592730167858712190447738131900483633572769906230056893763392378692216104723483117171625271225115361781853891212622433931)
    elseif submission == "SIKEp503"
        P2=E_start(12017738389637557970675524795850667169777681210763628189179662907750502772728208484952322006033352796924890045686546794284406334817614811666587968210710*ii + 3741536578112620259306864439330247072191433334600559419329602129392724050667231655818134250463729909286875035153080640348434082477771328241019989948786, 3801813006264040433113672585684832594336495829457220195406810473618698018129723245875585313755383321694984356798302772412349580203335176358144892375330*ii + 12266924186150221535482490080851707299526365681460336737932728905334264683640857495558215529026237578632803709868104890997451494210281233467257202139927)
        Q2=E_start(9209347623880815000767768926428426871445180866633021703364356165973632105283159723443122151743973586613265331888387781831380811470306537402609116185890*ii + 8150480068238950912619024133237362454251034634949434136782459596309000916297149859857491999582415221247918744686482134696258669580240115826619757124164, 2750594819614060426719866874452409762347997349668817169184144983728517840559215839647520246721231669722268003576641540239383283588708170478361625024624*ii + 8324743432864472583287225365306081746194591942764928430049617280735509149656890220697617966250229338303639470510194551956052645784441539506165136811016)
        P3=E_start(6128025476006226272622841313763454376564005517324991781088549841457879802957594069066309255061484290314098533790129600511342428077345358390913191308293*ii + 8432608572904854196954177634419455056866722567870580168992941008001189078816880430996165107185431237401940940299657380298892920005355024897834951579919, 3511193738487323444263492971996594812032164900628402095352803137588194817624447812915713602090517191797971845447710086646059045276870538277669633741603*ii + 1991065526199445499879200913324551548029793302334080211289015157102346682547187382904957732851722844872170153190687279889286007676467532405494103774831)
        Q3=E_start(12109122986045432987311177546548147078545660552887647670059398178822240839943592797858796218323264076887434326081818323762719883307423799301167007993923*ii + 4305842298420692182464635934796514917614031093212572154457729971506305164050534941373251597249420595873867438639964283186430987275365184779742688660858, 4561600635887323697039522300244136070750374648129846612309961030719787630451828247833692809102418419895925240030999190159172530829351466290559425361583*ii + 5992790065142832522698819660068091981675448248371440426251306787294442417605099143391707093264013408264670355602481378976379213527489185010677897550112)
    elseif submission == "SIKEp610"
        P2=E_start(1198213395864278873270581213633831493697761470760496032403450921021628974515713274188139978939075839139731499853898924052430291153278777099618771148282110206345577794553887341765813045*ii + 913789408507692310607550544115789068662430398941959701292001734656019702228939362093530607030852849058049236518089859015306227576478072030112986438471892062956794125038505027051688284, 901633763202672870072812790995706157509360931876747425287143469024255661827380911250219529163376722929439234603601300840776243683131496705330799192880903882102760831398001617579491096*ii + 2150355177771533080343765117786586046160560828498139674177718440570463801686497047785485501488194176144913396709831537444470575237469116969758283676418964897294241097459818113537714874)
        Q2=E_start(2589568881737631372536474135039328133055988019053271347333492277129494480607706972676832506105981823596252317067341055511489833543356596374917565669795790415201288453582644987851667830*ii + 872235231277436677058021940349449543089362307915123231514218803348407274470827308425994392399756132159287166401596479971564145705734948259061274938286900407107273159330680801684707148, 1589210866387269686586025337668746175117893317445101686957179294146766209570368716427122888851325889417937668807142575229330125205937369832648538232686663243435971204945583648707610387*ii + 170413343514353825846672292852244975416276623879532118798701421487035474379832728153590414722648963525757046375491270946988741147487540097078986108888086092092032875924066732225242081) 
        P3=E_start(2074881915471039154644861463483056738393820957344931343972780295380204912988463552073439235730324851905753700020070153123796046392021139696851418400565270919635362029513018979858982224*ii + 2175820563631061809577915034414556709169292491000722443676904410877246850473570468331539710871595432989152692176625180687273425784906779414037290264194983128449366994959939504808206589, 1204772222427807261233377357924335388838373086306548186931384801785672874395726396932331708872943773245144954322614714465781789937772286341887684145162574527450951458996029708771383926*ii + 380929965218402123521137172097466760051980591646908006279313597330847031146384009714212641850303189135305736905155414852395342063194542410314744189622308818382138509522966857516380158)
        Q3=E_start(2194683973083542248982820912328026877660306274469563633422017964090838515558154288626588688812562555186400703951348840311964507219722177883320635641084573624514521606669354693262859505*ii + 1739382361613201357449659175593778474218081759046107561540936419110784753678677452593635965106626104586327825116247768526369266315737606541620936002826364506644152100140702441547718442, 271069932169249038232885241543765335059601556192864767860503545202061736432478114163791711465731587236264788404937405565814247894306074771276764608988971970860004800599363632240197786*ii + 1558722834920482173422663923508684877036187195126091807791040662544552872141032493795803178012637640693173795527228064660206121853609751614592808747774017605987577156659086514139718168) 
    elseif submission == "SIKEp751"
        P2=E_start(7102581394397906173931030339051001595927396405824551321253838913054582914760510230833309731882783570238238736014659305838028694820905750043578782199010640477009275379850293790495254369704718899320848253146528134605664613038143*ii + 10195700760135141470728942535550116072219463932125544239560006994144466267303056387427813016763271889595193476769647978278908806449153875964134575569353231368199257822285210439538505844763838534502706649051479837761849192128897, 5571507248256151520675792003037204416327119022067222045924898860095049386111277044955445487805177986156446157188225448993496699286894549585671965567527684888825699650504588256883784106215181874654148987776304740342829745233952*ii + 5588053410618404630405050135674063646063690156895091698777928343226638389598396277849738858736144344916847439196218222052899700030854740503968443900664671431449798339410446092825583638643670951970622796616711250958943527302447)
        Q2=E_start(2358815041989864119834207146009423509228623935115193757093202168490780835711631899116591703485237787261915365752022846492910003548764251249356526116008250433301175248030716418677399816891241775637046440321846561979328941895125*ii + 8128656348473997220955292063955970973700441098559937416852922724158515980258247795506484422012139523704436998266460931883096479053925391166963052928173616027921063703460889725511122968785281045244621303652347225897907619940177, 7892921014409233326067825029546575430783317975481536215307282217175539008681320665998163059833915107095990044182813536302324327817656923630980280940978949546189048850371982335409231819934530100397370560908334248605034889308509*ii + 2494294516595364528793908678996642600808223430352841987785341664858092249797844834598156621401806942371539734765656321038371730499385680847414615672744013833711173186125622188856269494775690424891252486391712488379670978332585)
        P3=E_start(6035332350044883095874524557042817211791098600196154898109438280354274119604075643162778279012306117623528667727719398409398497058649778305686879082160357587836101331319497014519583461389641167654212327156529324370978699795182*ii + 4495792896164022643184796403365208536078072050546311525957418460048262679898689504784130699216754641555715811623764257346152578772805211326552538494211687631651218768428491326855878523759454573039614064207941548444814652896301, 896624471236204841154799864816694106161628365621639257565817865237420158807765086864324713555658847384439045832043439830521605503955010613790151598441543998765405875802050567915866378497914855696713933868490311382248793096941*ii + 8323586430225709397453264760205857803945773154970203180394374585526146118852561159959249580926461674871768709182284369970800422973957699873304095636951683628421976733681993139133516039152706697960700863170957485832946897103047)
        Q3=E_start(1457337161349247651666509585713440170782201265168447797684470362287484876905203560952709962661424094508682420014740889842301993057996263964287425606765347739126107115569451739644972874763504365898745106250281819326259034710069*ii + 2961750580505269909622364115925099950125320832427319025052236159635903348161690335610323689472146695225669063464177703692046719456251440488177627449269118173403434701360054427173865496998370300171015157386531164199925827483651, 7651109393393355029086319298815124371128021463619299634019362860330965596220815191270975106778043057555465193167907333910146215038450777461859106767261868662344548338763037474840883963373148861180703488852267621871069238509576*ii + 5485326598382211597430352084667251749946297743754336114202428088606411117117328778726181619255814130563598710273573897729658903176060224493200951193009350228137916473893596986323811825726778311951693549341592733172037389763118)
    else
        error("invalid submission")
    end
    return P2, Q2, P3, Q3
end


function gen_bob_keypair(E_start, b, P2, Q2, P3, Q3)
    # generate challenge key
    bobs_key = rand(1:BigInt(3)^b)
    K = P3 + bobs_key*Q3
    EB, phi = Pushing3Chain(E_start,K,b)
    PB, QB = P2, Q2
    for f in phi
        PB, QB = f(PB), f(QB)
    end
    return bobs_key, EB, PB, QB
end
